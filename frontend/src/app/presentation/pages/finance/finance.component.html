<app-page-toolbar [title]="'Finanzas'"></app-page-toolbar>

<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mt-4">
  @for(card of summaryCards; track $index){
  <mat-card appearance="outlined">
    <mat-card-content>
      <div class="flex flex-col items-center justify-center gap-2">
        <i-tabler class="scale-160" [name]="card.icon"></i-tabler>
        <span class="text-lg">
          {{ card.title }}
        </span>
        <span class="text-lg font-bold">{{
          card.amount | currency : "USD"
        }}</span>
        <span
          [ngClass]="{
            'text-green-400': card.variation >= 0,
            'text-red-400': card.variation < 0
          }"
          class="text-sm"
        >
          {{ card.variation >= 0 ? "+" : "" }}{{ card.variation }}%
        </span>
      </div>
    </mat-card-content></mat-card
  >
  }
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
  <mat-card appearance="outlined" class="h-full">
    <mat-card-header>
      <mat-card-title class="text-lg font-semibold">
        Facturación mensual
      </mat-card-title>
    </mat-card-header>
    <mat-card-content class="mt-4">
      <div class="w-full flex justify-center">
        <canvas
          baseChart
          [data]="lineChartData"
          [labels]="lineChartLabels"
          [options]="lineChartOptions"
          [type]="'line'"
        >
        </canvas>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card appearance="outlined" class="h-full">
    <mat-card-header>
      <mat-card-title class="w-full text-lg font-semibold">
        Métodos de Pago
      </mat-card-title>
    </mat-card-header>
    <mat-card-content class="mt-4">
      <div class="w-full flex justify-center">
        <canvas
          baseChart
          [data]="barChartData"
          [options]="barChartOptions"
          [type]="'bar'"
        >
        </canvas>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<div class="grid items-start grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
  <mat-card appearance="outlined">
    <mat-card-header>
      <mat-card-title>Últimos cobros</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <mat-list>
        <mat-list-item>
          <div class="w-full flex font-semibold">
            <div class="w-1/3">Paciente</div>
            <div class="w-1/3">Método de pago</div>
            <div class="w-1/3 text-right">Monto</div>
          </div>
        </mat-list-item>

        @for(payment of recentPayments; track $index){
        <mat-list-item>
          <div class="w-full flex items-center text-sm">
            <div class="w-1/3">{{ payment.patient }}</div>
            <div class="w-1/3">
              {{ payment.method | titlecase }}
            </div>
            <div class="w-1/3 text-right text-green-400 font-medium">
              ${{ payment.amount | number : "1.0-2" }}
            </div>
          </div>
        </mat-list-item>
        }
      </mat-list>
    </mat-card-content>
  </mat-card>

  <mat-card appearance="outlined">
    <mat-card-header>
      <mat-card-title class="text-lg font-semibold">
        Registrar Cobro
      </mat-card-title>
    </mat-card-header>
    <mat-card-content class="mt-4 flex flex-col">
      <form [formGroup]="paymentForm">
        <div class="my-2 grid grid-cols-2 gap-4">
          <div class="col-span-1">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Forma de Pago</mat-label>
              <mat-select formControlName="paymentMethod">
                <mat-option [value]="paymentMethodEnum.Cash"
                  >Efectivo</mat-option
                >
                <mat-option [value]="paymentMethodEnum.Transfer"
                  >Transferencia</mat-option
                >
                <mat-option [value]="paymentMethodEnum.DebitCard"
                  >Tarjeta de Débito</mat-option
                >
                <mat-option [value]="paymentMethodEnum.CreditCard"
                  >Tarjeta de Crédito</mat-option
                >
              </mat-select>
            </mat-form-field>
          </div>
          <div class="col-span-1">
            <mat-form-field
              appearance="outline"
              floatLabel="always"
              class="w-full"
            >
              <mat-label>Valor</mat-label>
              <input
                matInput
                type="number"
                formControlName="totalAmount"
                placeholder="0"
                class="text-end"
              />
              <span matTextPrefix>$&nbsp;</span>
            </mat-form-field>
          </div>

          @if(paymentForm.get('paymentMethod')?.value ===
          paymentMethodEnum.CreditCard){
          <div class="col-span-1">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Cuotas</mat-label>
              <mat-select formControlName="installments">
                <mat-option value="1"
                  >1 cuota ($ {{ calculateInstallmentAmount(1) }})</mat-option
                >
                <mat-option value="3"
                  >3 cuotas ($ {{ calculateInstallmentAmount(3) }})</mat-option
                >
                <mat-option value="6"
                  >6 cuotas ($ {{ calculateInstallmentAmount(6) }})</mat-option
                >
                <mat-option value="9"
                  >9 cuotas ($ {{ calculateInstallmentAmount(9) }})</mat-option
                >
                <mat-option value="12"
                  >12 cuotas ($
                  {{ calculateInstallmentAmount(12) }})</mat-option
                >
                <mat-option value="18"
                  >18 cuotas ($
                  {{ calculateInstallmentAmount(18) }})</mat-option
                >
              </mat-select>
            </mat-form-field>
          </div>
          }
        </div>
      </form>
    </mat-card-content>
    <mat-card-actions class="justify-end">
      <button mat-flat-button (click)="paymentRegister()">Registrar</button>
    </mat-card-actions></mat-card
  >
</div>
